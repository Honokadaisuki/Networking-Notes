# Chapter 19 逻辑寻址

![image-20210620224317997](Chapter19-22.assets/image-20210620224317997.png)

哈哈, 全加粗了.



## IPv4地址

常识性的东西就不说了.

### 地址分类

ABCDE五类地址

![image-20210620224445372](Chapter19-22.assets/image-20210620224445372.png)

重点在ABC类上.

#### A类地址

A类地址网络号只有前8位, 其中第一位必须是0.

网络号全0表示本网络, 是预留的.

网络号后七位全1用于本地环回测试, 也是预留的.

**所以A类地址有 $$ 2^{7} - 2$$ 个网络**

主机号是后面24位.

主机号全0表示网络号指定的该网络, 预留.

主机号全1表示广播, 预留.

**所以A类地址一个网络最多有 $$ 2^{24} - 2$$ 个主机**

#### B类地址

网络号有前面16位, 其中前两位必须是10.

网络号128.0是不指派, 最少也得是128.1

**所以B类地址有 $$ 2^{14} - 1$$ 个网络**

类似的, **B类地址一个网络最多有 $$ 2^{16} - 2$$ 个主机**

#### C类地址

与B类地址类似:

**C类地址有 $$2^{21}-1$$ 个网络, 最多$$2^{8}-1$$ 个主机**



### 几类特殊的地址

#### 网络地址

就是主机号全为0, 只能用来标识网络, 不能分配给主机

#### 直接广播地址

网络号+全1的主机号, 只能用来当目的地址, 在这个网络上的所有设备都将接受处理.

#### 受限广播地址

就是255.255.255.255, 只能当目的地址. 

这个网络的所有设备都要收.

不是整个英特网, 路由器会屏蔽这个包.

是一个**E**类地址

#### 这个网络中的这个主机

就是0.0.0.0, 在主机第一次加入网络的时候问ip用.

是一个**A**类地址

#### 这个网络的特定主机

就是网络号全0+主机号

是一个**A**类地址

#### 环回地址

网络号是127, 主机号随意.

是一个**A**类地址

## NAT

NAT可以解决ip地址不够用的问题.

其实就是一个NAT服务器后面罩着一群小东西, 小东西用一个端口发的数据包到了NAT服务器就变成了NAT的另一个端口发的. 

然后NAT服务器会记录下来这个对应关系, 收到对应的数据包再按照NAT表发回去.

如果从外面收到NAT表里面没有的数据包, 那就把他给扔了.

## 子网划分

### 子网

网络号+主机号不合理, 借用主机号的几位区别子网.

划分子网纯属网络单位内部的事情, 在外面看他还是一个网络.

### 子网掩码

子网掩码标识网络地址.

子网掩码与IP地址按位与结果就是他的网络地址, 只有子网掩码按位与之后相等的两个IP地址, 才在一个子网里.

### 划分子网的方法

#### 直接按类

ABC类+子网划分, 不太好吧

#### CIDR

无分类编址.

就是没有ABC类之分, 一切都靠子网掩码.

IP地址化成两部分: **网络前缀; 主机号**

用斜线记法: ip地址/掩码1的长度

就是前多少位是前缀, 掩码长度就多少

##### 路由聚合/超网

就是几个前几位相同的地址块, 可以合在一起用一个CIDR地址块包含起来, 就是看最长公共前缀.



## IPv6地址

128位, 16字节, 32个数, 8段.

### 缩短

每段开头有连续的0, 可以省去, 但是一段至少有一位.

如果有连续的全0段, 可以用一个**::**表示.

但是一个地址里最多只能出现一个**::**



# Chapter 20 IP协议

## IP数据包的格式



![image-20210621184004060](Chapter19-22.assets/image-20210621184004060.png)



一个一个说

1. 版本: 4bits, 说明IP数据报用的IPv4还是v6
2. 首部长度: 4bits, ipv4数据报首部最大60字节, 一般都是20字节, 这个0-15的数字*4就是字节数. **单位是4字节**
3. 服务类型: 8bits, 没人用过.
4. 总长度: 就是包括头部的, 整个IP数据报的长度, 最长65535B(具体多长限制于MTU) **单位是1字节**
5. 标识: 是一个计数器, 用来产生数据包的标识
6. 标志: 前两位是MF/DF, 第三位没人用, 分片用的.
7. 片漂移: 分片用的 **单位是8字节**
8. 生存时间(TTL): 到一个路由器就-1, 为0就给他扔了, 防止他转圈.
9. 协议: 标明这个数据报应该交给什么协议处理.
10. 首部校验和: 用一个更简单的方式, **只检查首部是否有错**.
11. 源地址
12. 目的地址



## 分段

### MTU

Maximum Transmission Unit, **链路层**的一个属性.

就是一个帧里面他能装的最大数据字节数, 不包括链路层的头.

也就是说一个IP数据报长度不能超过他的下层链路层的MTU.

以太网的MTU是1500



所以数据一大肯定是要分段的

### 标志位MF

More Frames: 指示后面是不是还有这一帧被分出来的续帧.

也就是一个长达14800B的数据被做成了ip数据报, 长度15020, MF=0;

但是中间遇到了以太网, 看门的路由器就会把他分成10段, 每段1480B, 加上头正好1500B.

这十个数据报里面, 前九个的MF都是1, 只有最后的MF=0;



## IPv6数据报格式

![image-20210621191854631](Chapter19-22.assets/image-20210621191854631.png)

好, 除了版本都不一样.

![image-20210621192721966](Chapter19-22.assets/image-20210621192721966.png)

拓展首部是算在载荷里的.

1. 版本: 4bits, 就是v4或者v6

2. 通信量类, 8bits, 是一种优先级. 优先级中有两类, 前8个优先级可以被拥塞控制, 后8个不能被拥塞控制.

3. 流标号, 20bits, 好像有一些神奇的用途, 视频和语音的传输之类的.

4. 有效载荷长度: 16bits, 拓展首部+数据的长度, 最长能表示64KB.

5. 下一个首部, 8bits, 协议字段或者类似链表指向下一个可选字段

6. 跳数限制, 8bits, 类似TTL

7. 源地址, 128bits.

8. 目的地址, 128bits.

   ![image-20210621193900812](Chapter19-22.assets/image-20210621193900812.png)

## IPv4和IPv6混合

三种技术:

1. 双协议栈

2. 头部转换

3. 隧道

   